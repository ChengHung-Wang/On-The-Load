var KEYUP=38;var KEYDOWN=40;var KEYLEFT=37;var KEYRIGHT=39;var helvetica=' "Helvetica Neue", Helvetica, Arial, sans-serif';var COLORS_LANEMARKER=0;var cntx=null;function cntxClearRect(e,t){cntx.clearRect(0,0,e,t)}function cntxGlobalAlpha(e){cntx.globalAlpha=e}function cntxFillRect(e,t,a,r){cntx.fillRect(e,t,a,r)}function cntxCreateLinearGradient(e,t,a,r){return cntx.createLinearGradient(e,t,a,r)}function cntxStrokeStyle(e){cntx.strokeStyle=e}function cntxStroke(){cntx.stroke()}function cntxFillStyle(e){cntx.fillStyle=e}function cntxBeginPath(){cntx.beginPath()}function cntxMoveTo(e,t){cntx.moveTo(e,t)}function cntxArc(e,t,a,r,i,n){cntx.arc(e,t,a,r,i,n)}function cntxLineTo(e,t){cntx.lineTo(e,t)}function cntxClosePath(){cntx.closePath()}function cntxFill(){cntx.fill()}function cntxFillText(e,t,a){cntx.fillText(e,t,a)}function cntxSave(){cntx.save()}function cntxRestore(){cntx.restore()}function cntxTranslate(e,t){cntx.translate(e,t)}function cntxRotate(e){cntx.rotate(e)}function cntxDrawImage(e,t,a,r,i,n,s,c,o){cntx.drawImage(e,t,a,r,i,n,s,c,o)}var M=Math;var PI=Math.PI;function mathRand(){return M.random()}function mathRandInt(e){return M.floor(mathRand()*e)}function sin(e){return M.sin(e)}function cos(e){return M.cos(e)}var SCRATCHWIDTH=600,SCRATCHHEIGHT=600,SPRITESWIDTH=2400,SPRITESHEIGHT=2400,BACKGROUNDLAYERWIDTH=1280,BACKGROUNDLAYERHEIGHT=480,OVERHEADTRACKWIDTH=600,OVERHEADTRACKHEIGHT=600,scratchCanvas=createCanvas(SCRATCHWIDTH,SCRATCHHEIGHT),sprites=createCanvas(SPRITESWIDTH,SPRITESHEIGHT);spritesCanvas=sprites.c,spritesContext=sprites.x,backgroundLayer3=createCanvas(BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT),backgroundLayer2=createCanvas(BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT),backgroundLayer1=createCanvas(BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT),overheadTrack=createCanvas(OVERHEADTRACKWIDTH,OVERHEADTRACKHEIGHT),SPRITES_STREETLIGHTLEFT=SPRITES_STREETLIGHTRIGHT=SPRITES_CARLEFT=SPRITES_CARRIGHT=SPRITES_CARSTRAIGHT=SPRITES_TURNLEFT=SPRITES_TURNRIGHT=SPRITES_FLOWERS=0,SPRITES_BUILDINGS=[],COLORS_FOG=0;var DARKGREY="#222222";var MEDIUMGREY="#cccccc";var LIGHTGREY="#e5e5e5";function eraseScratch(){scratchCanvas.x.clearRect(0,0,SCRATCHWIDTH,SCRATCHHEIGHT)}function createCanvas(e,t){var a=document.createElement("canvas");a.width=e;a.height=t;var r=a.getContext("2d");return{c:a,x:r}}var spriteDstX=0;var spriteDstY=0;var spriteMaxRowHeight=0;function resetGraphics(){spriteDstX=0;spriteDstY=0;spriteMaxRowHeight=0;spritesContext.clearRect(0,0,SPRITESWIDTH,SPRITESHEIGHT);backgroundLayer1.x.clearRect(0,0,BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT);backgroundLayer2.x.clearRect(0,0,BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT);backgroundLayer3.x.clearRect(0,0,BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT)}function drawFuzzyCircle(e,t,a,r){var i=0;cntxFillStyle(r);var n=a+a*mathRand();cntxBeginPath();cntxMoveTo(e+n*cos(i),t+n*sin(i));for(var s=1;s<30;s++){i=s*PI*2/30;n=a+a*mathRand();cntxLineTo(e+n*cos(i),t+n*sin(i))}cntxClosePath();cntxFill()}function getScratchSpriteBounds(){var e=scratchCanvas.x.getImageData(0,0,scratchCanvas.c.width,scratchCanvas.c.height);var t=new Uint32Array(e.data.buffer);var a,r;var i=scratchCanvas.c.width;var n=scratchCanvas.c.height;var s=i,c=n,o=0,l=0;for(r=0;r<n;r++){for(a=0;a<i;a++){if(t[a+r*i]>0){if(a<s){s=a}if(a>o){o=a}if(r<c){c=r}if(r>l){l=r}}}}var d=l-50;if(d<0){d=0}var h=i;var u=0;for(r=d;r<l;r++){for(a=0;a<i;a++){if(t[a+r*i]>0){if(a<h){h=a}if(a>u){u=a}}}}return{x:s,y:c,w:o-s,h:l-c,cx:h-s,cw:u-h}}function newSprite(e){var t=e||0;var a=getScratchSpriteBounds();if(spriteDstX+a.w>SPRITESWIDTH){spriteDstX=0;spriteDstY+=spriteMaxRowHeight;spriteMaxRowHeight=0}if(a.h>spriteMaxRowHeight){spriteMaxRowHeight=a.h}spritesContext.save();var r=spriteDstX;if(t){spritesContext.scale(-1,1);r=-spriteDstX-a.w;a.cx=a.w-a.cx-a.cw}spritesContext.drawImage(scratchCanvas.c,a.x,a.y,a.w,a.h,r,spriteDstY,a.w,a.h);spritesContext.restore();var i={x:spriteDstX,y:spriteDstY,w:a.w,h:a.h,cx:a.cx,cw:a.cw};spriteDstX+=a.w+5;return i}function createTurnArrows(){cntx=scratchCanvas.x;eraseScratch();cntxFillStyle("#996644");cntxFillRect(0,0,200,200);cntxFillStyle("#996644");cntxFillRect(10,200,10,10);cntxFillStyle("#996644");cntxFillRect(180,200,10,10);cntxFillStyle(MEDIUMGREY);cntxFillRect(10,10,180,180);cntxBeginPath();cntxMoveTo(20,100);cntxLineTo(160,30);cntxLineTo(160,170);cntxLineTo(20,100);cntxFillStyle("#cc2211");cntxFill();cntxFillStyle(MEDIUMGREY);cntxFillRect(10,10,20,180);SPRITES_TURNLEFT=newSprite();SPRITES_TURNRIGHT=newSprite(1)}function smallTree(e,t){var a=[];var r=0;var i=0;a[i++]=0;var n=1;for(var s=0;s<e;s++){r=r+mathRand()*t;a[i++]=r}while(r>0){r=r-mathRand()*t;a[i++]=r}return a}function createBackgroundTrees(){cntx=backgroundLayer1.x;var e=["#114433","#114e33","#115433","#113433","#114433"];var t=0;for(var a=0;a<4;a++){var r=t;var i=10+40*mathRand();for(var n=0;n<i;n++){var s=smallTree(8,7);var c=mathRandInt(e.length);cntxFillStyle(e[c]);cntxBeginPath();cntxMoveTo(r,240-s[0]);for(var o=1;o<s.length;o++){cntxLineTo(r+o,240-s[o])}cntxClosePath();cntxFill();r+=2+mathRand()*4}var e=["#226639","#115e33","#316433","#215433","#114433"];var r=t;for(var n=0;n<i;n++){var s=smallTree(4,4);var c=mathRandInt(e.length);cntxFillStyle(e[c]);cntxBeginPath();cntxMoveTo(r,240-s[0]);for(var o=1;o<s.length;o++){cntxLineTo(r+o,240-s[o])}cntxClosePath();cntxFill();r+=2+mathRand()*5}t=r+50+mathRand()*180}}function terrain(e){cntx=backgroundLayer2.x;var t=[];var a=[];var r=[];var i=[];var n=0;var s=0;var c=1;c=.1+3*mathRand();var o=20*100*mathRand();for(var l=0;l<100;l++){n=n+mathRand()*c;t[s]=n;a[s]=n;s++;c+=.01}var o=5+8*mathRand();for(var l=0;l<o;l++){n=n+(.4-mathRand())*2;a[s]=n;t[s++]=n}var d=[];var h=n;while(h>0){h-=mathRand()*5;d.push(h)}if(mathRand()>.6){o=160*mathRand()}else{o=20*mathRand()}for(var l=0;l<o;l++){n=n+(.4-mathRand())*2;t[s++]=n}while(n>0){n=n-mathRand()*c;t[s++]=n;c-=.003;if(c<0){c=.03}}for(var l=0;l<a.length-20;l++){h=a[l]+mathRand();r.push(h)}for(var l=0;l<r.length-10;l++){h-=mathRand()*2;i.push(h)}var u=260;var f=e;cntxFillStyle("#114433");cntxBeginPath();cntxMoveTo(f,u-t[0]);for(var x=1;x<t.length;x++){cntxLineTo(f+x,u-t[x])}cntxClosePath();cntxFill();f=e;cntxFillStyle("#224a33");cntxBeginPath();cntxMoveTo(f,u-a[0]);for(var x=1;x<a.length;x++){cntxLineTo(f,u-a[x]);f++}for(var x=1;x<d.length;x++){cntxLineTo(f,u-d[x]);if(mathRand()>.4){f--}else if(mathRand()>.4){f++}}cntxClosePath();cntxFill();f=e+4;cntxFillStyle("#335a3a");cntxBeginPath();cntxMoveTo(f,u-r[0]);for(var x=1;x<r.length;x++){cntxLineTo(f,u-r[x]);f++}for(var x=1;x<i.length;x++){cntxLineTo(f,u-i[x]);if(mathRand()>.8){f++}else if(mathRand()>.1){f--}}cntxClosePath();cntxFill();return t}function createBackgroundMountains(){var e=0;for(var t=0;t<20;t++){terrain(e);e+=3+mathRand()*100}}var tree={leavesColor:"",draw:function(){cntxTranslate(500/2,500);this.leavesColor="#"+(16777216+mathRand()*16777215).toString(16).substr(1,6);cntx.lineWidth=1+mathRand()*20;cntx.lineJoin="round";this.branch(0)},branch:function(e){if(e<12){cntxBeginPath();cntxMoveTo(0,0);cntxLineTo(0,-500/10);cntxStroke();cntxTranslate(0,-500/10);var t=-(mathRand()*.1)+.1;cntxRotate(t);if(mathRand()*1<.6){cntxRotate(-.35);cntx.scale(.7,.7);cntxSave();this.branch(e+1);cntxRestore();cntxRotate(.6);cntxSave();this.branch(e+1);cntxRestore()}else{this.branch(e)}}else{cntxFillStyle(this.leavesColor);cntxFillRect(0,0,500,200);cntxStroke()}}};var SPRITES_TREES=[];function createTrees(){SPRITES_TREES=[];for(var e=0;e<6;e++){var t=.6;var a=false;var r=0;while(!a){cntx=scratchCanvas.x;scratchCanvas.x.save();eraseScratch();tree.draw();var i=getScratchSpriteBounds();a=i.w<300&&i.h<400||r>5;scratchCanvas.x.restore();r++}SPRITES_TREES[e]=newSprite()}}function backgroundBuilding(e,t,a,r){cntx=backgroundLayer1.x;var i=30;var n=20;var s=2;var c=1;var o=1;var l=4;var d=8;if(t==1){c=2;o=2;l=3;d=10;i=40;n=25}if(t==2){c=4;l=2;d=6;i=20;n=18}var h=260;i+=30*mathRand();cntxFillStyle(a);cntxFillRect(e,h-i,n,i);if(mathRand()<.4){var u=5;var f=8;cntxFillRect(e+u,h-(i+f),n-2*u,i+f)}if(mathRand()<.2){var u=5;var f=13;var x=2;cntxFillRect(e+u,h-(i+f),x,i+f)}for(var v=0;v<d;v++){var p=s+v*(o+s);for(var g=0;g<l;g++){var R=s+g*(c+s);cntxFillStyle(r);cntxFillRect(e+R,h-i+p,c,o)}}}function createBackgroundBuildings(e){var t="#777799";var a="#9999ee";if(e){t="#060606";a="#929156"}var r=0;for(var i=0;i<80;i++){var n=mathRand();if(n<.4){backgroundBuilding(r,0,t,a)}else if(n<.6){backgroundBuilding(r,1,t,a)}else{backgroundBuilding(r,2,t,a)}r+=10+mathRand()*30}var t="#9999aa";var a="#aaaaee";if(e){t="#101010";a="#929156"}var r=0;for(var i=0;i<80;i++){var n=mathRand();if(n<.4){backgroundBuilding(r,0,t,a)}else if(n<.6){backgroundBuilding(r,1,t,a)}else{backgroundBuilding(r,2,t,a)}r+=10+mathRand()*30}}function createBuildings(e){SPRITES_BUILDINGS=[];for(var t=0;t<4;t++){eraseScratch();cntx=scratchCanvas.x;var a=100+mathRand()*80;if(e){a=10+mathRand()*20}cntxFillStyle("rgb("+a+","+a+","+a+")");cntxFillRect(0,30,240,500);var r=24,i=15,n=8,s=8,c=10;var o=col=x=y=0;for(o=0;o<18;o++){y=30+n+o*(i+c);for(col=0;col<7;col++){x=n+col*(r+s);if(e){if(mathRand()>.7){cntxFillStyle("#ffffec");cntxFillRect(x,y,r,i);cntxFillStyle("#bbbb88");cntxFillRect(x,y+i/2,r,i/2)}else{cntxFillStyle("#112237");cntxFillRect(x,y,r,i);cntxFillStyle("#111a30");cntxFillRect(x,y+i/2,r,i/2)}}else{cntxFillStyle("#5555a7");cntxFillRect(x,y,r,i);cntxFillStyle("#444495");cntxFillRect(x,y+i/2,r,i/2)}}}SPRITES_BUILDINGS[t]=newSprite()}}function createStreetlights(e){cntx=scratchCanvas.x;eraseScratch();cntxSave();cntxFillStyle("#999999");if(e){cntxFillStyle("#555555")}var t=7;cntxFillRect(40,150,t,300);cntxBeginPath();cntxArc(70,150,30,PI,-PI/2);cntxLineTo(70,150-30+t);cntxArc(70,150,30-t,-PI/2,PI,true);cntxLineTo(70-30,150);cntxFill();cntxFillRect(70,150-30,70,t);cntxFillRect(130,150-30-1,35,6);cntxFillStyle("#aaaaaa");if(e){cntxFillStyle("#777777")}cntxFillRect(40+t-4,150,2,300);cntxFillRect(70,150-30+t-4,70,2);cntxBeginPath();cntxArc(70,150,30-t+4,PI,-PI/2);cntxLineTo(70,150-30+t);cntxArc(70,150,30-t,-PI/2,PI,true);cntxLineTo(70-30,150);cntxFill();cntxFillStyle("#aaaaaa");if(e){cntxFillStyle("#999999")}cntxFillRect(40+t-2,150,2,300);cntxFillRect(70,150-30+t-2,70,2);cntxBeginPath();cntxArc(70,150,30-t+2,PI,-PI/2);cntxLineTo(70,150-30+t);cntxArc(70,150,30-t,-PI/2,PI,true);cntxLineTo(70-30,150);cntxFill();if(e){cntx.filter="blur(2px)"}cntxFillStyle("#ffffff");cntxFillRect(128,150-30+4,38,12);if(e){cntxGlobalAlpha(.8);cntx.globalCompositeOperation="lighter";cntx.filter="blur(4px)";cntxFillRect(123,150-30+3,44,18);cntxGlobalAlpha(1)}SPRITES_STREETLIGHTLEFT=newSprite();SPRITES_STREETLIGHTRIGHT=newSprite(1);cntxRestore()}function createNightSky(){var e=BACKGROUNDLAYERWIDTH;var t=BACKGROUNDLAYERHEIGHT;cntx=backgroundLayer3.x;var a=cntxCreateLinearGradient(0,0,0,t);a.addColorStop(0,"#00111e");a.addColorStop(1,"#033d5e");cntxFillStyle(a);cntxFillRect(0,0,BACKGROUNDLAYERWIDTH,BACKGROUNDLAYERHEIGHT);var r=Math.round(e+t);for(var i=0;i<=r;i++){var n=mathRandInt(e);var s=mathRandInt(t);var c=mathRandInt(2)+1;var o=mathRandInt(9)+1;var l=mathRandInt(9)+1;var d=mathRandInt(360);if(c>1){cntx.shadowBlur=mathRandInt(15)+5;cntx.shadowColor="white"}cntxFillStyle("hsla("+d+", 30%, 80%, ."+o+l+")");cntxFillRect(n,s,c,c)}}function createLeaf(e){cntxFillStyle(e);cntxBeginPath();cntxArc(3,7,3,PI/2,PI);cntxArc(10,7,10,PI,PI*1.24);cntxArc(-4.7,7,10,PI*1.76,0);cntxArc(2.3,7,3,0,PI/2);cntxFill()}function createFlowers(){eraseScratch();cntx=scratchCanvas.x;var e=scratchCanvas.c;cntx.save();var t=cntxCreateLinearGradient(0,0,0,8);t.addColorStop(0,"#ff111e");t.addColorStop(1,"#aa3d5e");createLeaf(t);cntx.translate(0,20);createLeaf(t);cntx.translate(0,20);createLeaf(t);cntx.translate(0,20);createLeaf("#44aa55");cntx.restore();var a=100;for(var r=0;r<2;r++){var i=30;for(var n=0;n<60;n++){i+=4+6*mathRand();if(i>780){continue}var s=20+4*mathRand();a=100+r*16-s+mathRand()*12;if(mathRand()>.5){cntxFillStyle("#44aa55");cntxFillRect(i,a,2,s);cntxFillStyle("#66cc88");cntxFillRect(i,a,1,s)}else{cntxFillStyle("#449955");cntxFillRect(i,a,2,s);cntxFillStyle("#66aa88");cntxFillRect(i,a,1,s)}var c=mathRandInt(2)*20;var o=i-2;var l=a-6;cntxSave();cntxTranslate(o+3,l);cntxRotate(.3);cntxDrawImage(e,0,c,6,11,0,0,6,11);cntxRestore();cntxSave();cntxTranslate(o-3,l+1);cntxRotate(-.3);cntxDrawImage(e,0,c,6,11,0,0,6,11);cntxRestore();cntxSave();cntxTranslate(o,l);cntxDrawImage(e,0,c,6,11,0,0,6,11);cntxRestore();cntxSave();cntxTranslate(o+6,l+10);cntxRotate(.6);cntxDrawImage(e,0,60,6,11,0,0,6,11);cntxRestore()}}cntx.clearRect(0,0,22,300);SPRITES_FLOWERS=newSprite()}function fillPoints(e,t){cntxBeginPath();cntxFillStyle(t);cntxMoveTo(e[0],e[1]);for(var a=2;a<e.length;a+=2){cntxLineTo(e[a],e[a+1])}cntxClosePath();cntxFill()}function drawLine(e,t,a,r){cntxBeginPath();cntxMoveTo(e,t);cntxLineTo(a,r);cntx.stroke()}function createCar(){eraseScratch();cntx=scratchCanvas.x;var e=[8,194,11,206,14,214,18,216,41,215,46,213,47,205];fillPoints(e,DARKGREY);var e=[227,193,230,200,241,204,258,203,265,197,268,191];fillPoints(e,DARKGREY);var e=[5,192,25,206,296,190,302,164,298,149,296,145,292,111,289,103,294,101,294,91,297,84,263,72,208,14,167,2,66,3,45,7,8,55,5,65,7,88,2,97,1,151];fillPoints(e,"#ffffff");var e=[25,206,296,190,302,164,298,149,296,145,292,111,289,103,294,101,294,91,297,84,17,93,22,122,20,162,20,170,2,145,3,160,6,187];fillPoints(e,"#ffffff");var e=[20,108,294,96,296,89,19,98];fillPoints(e,"#226d7d");var e=[21,162,296,149,292,112,22,122];fillPoints(e,"#226d7d");var e=[42,86,260,79,208,21,60,24];var t=cntxCreateLinearGradient(0,19,0,90);t.addColorStop(0,"#4fa8f7");t.addColorStop(1,"#2d3c7c");fillPoints(e,t);e=[51,62,238,57,253,76,196,67,159,64,125,66,81,72,45,82];fillPoints(e,"#95eef7");var e=[27,83,33,77,46,27,21,70];fillPoints(e,"#4773dd");var e=[19,61,46,17,43,12,19,51];fillPoints(e,"#4773dd");var e=[3,99,10,113,18,120,17,106,11,86,5,91];fillPoints(e,"#ffd47e");var e=[21,127,19,145,20,158,106,153,105,124];fillPoints(e,"#b44258");var e=[20,158,106,153,105,142,19,146];fillPoints(e,"#5d2959");var e=[217,120,218,149,296,145,296,134,293,116];fillPoints(e,"#b44258");var e=[218,149,296,145,296,133,218,137];fillPoints(e,"#5d2959");var e=[21,173,300,159,299,149,21,162];fillPoints(e,"#bbbbbb");SPRITES_CARLEFT=newSprite(0);SPRITES_CARRIGHT=newSprite(1)}function createCar2(){eraseScratch();cntx=scratchCanvas.x;var e=scratchCanvas.c;var t=[5,197,143,197,141,87,1,87,4,106,1,121,1,180];fillPoints(t,"#ffffff");var t=[141,87,143,1,87,3,72,6,61,17,31,67,1,87];fillPoints(t,"#ffffff");t=[4,100,143,100,143,93,3,93];fillPoints(t,"#226d7d");t=[4,155,143,155,143,113,4,113];fillPoints(t,"#dddddd");t=[4,150,86,149,86,121,5,121,3,139];fillPoints(t,"#b44258");t=[4,149,86,149,86,138,4,138];fillPoints(t,"#5d2959");t=[22,131,22,134,73,134,73,131];fillPoints(t,"#d65d5b");t=[32,82,143,82,143,19,66,19];var a=cntxCreateLinearGradient(0,19,0,90);a.addColorStop(0,"#4fa8f7");a.addColorStop(1,"#2d3c7c");fillPoints(t,a);t=[47,59,143,59,143,64,78,68,38,77];fillPoints(t,"#95eef7");t=[13,197,16,205,23,208,49,207,56,202,58,197];fillPoints(t,DARKGREY);var t=[1,155,1,167,143,167,143,155];fillPoints(t,"#a9fb78");cntxSave();cntx.scale(-1,1);cntxDrawImage(scratchCanvas.c,0,0,143,210,-143-132,0,143,210);cntxRestore();SPRITES_CARSTRAIGHT=newSprite(0)}function createCars(){createCar();createCar2()}function utilPercentRemaining(e,t){return e%t/t}function utilInterpolate(e,t,a){return e+(t-e)*a}function utilIncrease(e,t,a){var r=e+t;while(r>=a)r-=a;while(r<0)r+=a;return r}var TitleScreen=function(e,t){this.canvas=e;this.context=t};TitleScreen.prototype={init:function(){camera.reset();track.buildTrack0()},keyDown:function(e){if(e.keyCode===88){startGame()}},keyUp:function(e){},renderRoad:function(){outlineOnly=true;var e=height;camera.y=400;camera.depth=.83909963117728;camera.x=0;var t=track.findSegment(camera.z);var a=utilPercentRemaining(camera.z,Track.segmentLength);camera.y=500+utilInterpolate(t.p1.world.y,t.p3.world.y,a);var r,i,n,s,c,o,l,d;var h=0;for(r=0;r<camera.drawDistance;r++){n=track.getSegment((t.index+r)%track.getSegmentCount());n.looped=n.index<t.index;n.clip=e;n.clip=0;camera.project(n.p1,0,n.looped,width,height,laneWidth);camera.project(n.p2,0,n.looped,width,height,laneWidth);camera.project(n.p3,0,n.looped,width,height,laneWidth);camera.project(n.p4,0,n.looped,width,height,laneWidth);if(n.p1.camera.z<=camera.depth||n.p3.screen.y>=n.p1.screen.y||n.p3.screen.y>=e)continue;renderSegment(n);e=n.p1.screen.y}},render:function(e){cntx=this.context;var t=getTimestamp();cntxFillStyle(DARKGREY);cntxFillRect(0,0,this.canvas.width,this.canvas.height);for(var a=0;a<30;a++){var r=100+a*10;context.font="italic "+r+"px "+helvetica;context.fontStyle="italic";var i=80+a*4;i=(i+t/6)%200;if(a==29){i=255}cntxFillStyle("rgb("+i+","+i+","+i+")");cntxFillText("racer",document.documentElement.clientWidth/2-a*11,300-a)}context.font="44px "+helvetica;cntxFillText("Arrow keys to drive, x for Turbo, z for Handbrake",38,570);cntxFillText("x To Start",423,460);camera.z=utilIncrease(camera.z,e*120,track.getLength());this.renderRoad()}};var Camera=function(){this.fieldOfView=100;this.y=0;this.z=0;this.drawDistance=300;this.depth=0;this.fogDensity=25;this.zOffset=0;this.yOffset=740;this.zOffset=700};Camera.prototype={reset:function(){this.depth=1/Math.tan(this.fieldOfView/2*Math.PI/180);this.yOffset=1740;this.zOffset=1500},project:function(e,t,a,r,i){var n=this.z;if(a){n-=track.getLength()}var s=this.x+t;e.camera.x=(e.world.x||0)-s;e.camera.y=(e.world.y||0)-this.y;e.camera.z=(e.world.z||0)-n;e.screen.scale=this.depth/e.camera.z;e.screen.x=Math.round(r/2+e.screen.scale*e.camera.x*r/2);e.screen.y=Math.round(i/2-e.screen.scale*e.camera.y*i/2)},update:function(e){this.z=cars[0].z-this.zOffset;if(this.z<0){this.z+=track.getLength()}camera.x=cars[0].x+cars[0].width/2;var t=track.findSegment(cars[0].z);var a=utilPercentRemaining(cars[0].z,Track.segmentLength);this.y=this.yOffset+utilInterpolate(t.p1.world.y,t.p3.world.y,a)}};var width=document.documentElement.clientWidth;var height=document.documentElement.clientHeight;var resolution=height/480;var bgLayer3Speed=.001;var bgLayer2Speed=.002;var bgLayer1Speed=.003;var bgLayer3Offset=0;var bgLayer2Offset=0;var bgLayer1Offset=0;var outlineOnly=false;var lastDriftDraw=0;function renderPolygon(e,t,a,r,i,n,s,c,o){var l=context;cntxFillStyle(o);cntxBeginPath();cntxMoveTo(e,t);cntxLineTo(a,r);cntxLineTo(i,n);cntxLineTo(s,c);cntxClosePath();if(outlineOnly){cntxStrokeStyle(MEDIUMGREY);cntxStroke()}else{cntxFill()}}function renderSegment(e){var t,a,r,i,n;var s=Math.floor(e.index/2)%2;var c=COLORS_KERBLIGHT;var o=COLORS_LANDLIGHT;if(s){c=COLORS_KERBDARK;o=COLORS_LANDDARK}if(!outlineOnly){cntxFillStyle(o);cntxFillRect(0,e.p3.screen.y,width,e.p1.screen.y-e.p3.screen.y)}var l=e.kerbWidth*e.p1.screen.scale*width/2;var d=e.kerbWidth*e.p4.screen.scale*width/2;renderPolygon(e.p1.screen.x-l,e.p1.screen.y,e.p1.screen.x,e.p1.screen.y,e.p4.screen.x,e.p4.screen.y,e.p4.screen.x-d,e.p4.screen.y,c);renderPolygon(e.p2.screen.x,e.p2.screen.y,e.p2.screen.x+l,e.p2.screen.y,e.p3.screen.x+d,e.p3.screen.y,e.p3.screen.x,e.p3.screen.y,c);if(!outlineOnly){var h=COLORS_ROAD;if(e.index==0){h=MEDIUMGREY}renderPolygon(e.p1.screen.x,e.p1.screen.y,e.p2.screen.x,e.p2.screen.y,e.p3.screen.x,e.p3.screen.y,e.p4.screen.x,e.p4.screen.y,h)}var u=50*e.p1.screen.scale*width/2;var f=50*e.p4.screen.scale*width/2;r=e.p1.screen.x+100*e.p1.screen.scale*width/2;i=e.p4.screen.x+100*e.p4.screen.scale*width/2;renderPolygon(r-u/2,e.p1.screen.y,r+u/2,e.p1.screen.y,i+f/2,e.p3.screen.y,i-f/2,e.p3.screen.y,COLORS_LANEMARKER);r=e.p2.screen.x-100*e.p1.screen.scale*width/2;i=e.p3.screen.x-100*e.p4.screen.scale*width/2;renderPolygon(r-u/2,e.p1.screen.y,r+u/2,e.p1.screen.y,i+f/2,e.p3.screen.y,i-f/2,e.p3.screen.y,COLORS_LANEMARKER);lanes=2;if(s){t=(e.p2.screen.x-e.p1.screen.x)/lanes;a=(e.p3.screen.x-e.p4.screen.x)/lanes;r=e.p1.screen.x+t;i=e.p4.screen.x+a;for(n=1;n<lanes;r+=t,i+=a,n++){renderPolygon(r-u/2,e.p1.screen.y,r+u/2,e.p1.screen.y,i+f/2,e.p3.screen.y,i-f/2,e.p3.screen.y,COLORS_LANEMARKER)}}if(COLORS_FOG!=0){renderFog(0,e.p1.screen.y,width,e.p3.screen.y-e.p1.screen.y,e.fog)}}function renderBackground(e,t,a,r,i){r=r||0;i=i||0;var n=BACKGROUNDLAYERWIDTH/2;var s=BACKGROUNDLAYERHEIGHT;var c=Math.floor(BACKGROUNDLAYERWIDTH*r);var o=0;var l=Math.min(n,BACKGROUNDLAYERWIDTH-c);var d=s;var h=0;var u=i;var f=Math.floor(t*(l/n));var x=a;context.drawImage(e.c,c,o,l,d,h,u,f,x);if(l<n)context.drawImage(e.c,0,o,n-l,d,f-1,u,t-f,x)}function renderSprite(e,t,a,r,i,n){var s=e.w*t*width/2;var c=e.h*t*width/2;r=r-c;var o=i?Math.max(0,r+c-i):0;if(o<c){context.drawImage(spritesCanvas,e.x,e.y,e.w,e.h-e.h*o/c,a,r,s,c-o);if(n!==false&&COLORS_FOG!=0){renderFog(a,r,s,c,n)}}}function renderExponentialFog(e,t){return 1/Math.pow(Math.E,e*e*t)}function renderPlayer(e,t,a,r,i,n){var s;if(r<0){s=SPRITES_CARLEFT}else if(r>0){s=SPRITES_CARRIGHT}else{s=SPRITES_CARSTRAIGHT}var c=player.width*e/s.w;var o,l;if(player.slipstreamTime>0||player.slipstream>0){cars[0].initSlipstreamLines();var d=0;if(player.slipstreamTime<=0){d=player.slipstream;while(d>1){d-=1}}cntxGlobalAlpha(1-d);for(o=0;o<cars[0].slipstreamLines.length;o++){var h=cars[0].slipstreamLines[o];cntxBeginPath();cntxMoveTo(h[0].screen.x,h[0].screen.y);for(l=1;l<h.length;l++){cntxLineTo(h[l].screen.x,h[l].screen.y)}cntxFillStyle(MEDIUMGREY);cntxFill()}cntxGlobalAlpha(1)}renderSprite(s,c,t,a+player.bounce,false);if(player.driftAmount>0){var u=getTimestamp();if(u-lastDriftDraw>100){cntxGlobalAlpha(.8);cntxFillStyle(MEDIUMGREY);var f=t+12;var x=a-4;cntxFillRect(f,x,50,10);f=t+260;cntxFillRect(f,x,50,10);cntxGlobalAlpha(1);lastDriftDraw=u}}if(player.turbo){var v=t+82;var p=a-10;drawFuzzyCircle(v,p,10,"#dd9925");drawFuzzyCircle(v,p,5,"#cccc55");v=t+230;drawFuzzyCircle(v,p,10,"#dd9925");drawFuzzyCircle(v,p,5,"#cccc55")}}function renderFog(e,t,a,r,i){if(i<1){cntxGlobalAlpha(1-i);cntxFillStyle(COLORS_FOG);cntxFillRect(e,t,a,r);cntxGlobalAlpha(1)}}function renderRender(){cntx=context;var e=track.findSegment(camera.z);var t=utilPercentRemaining(camera.z,Track.segmentLength);var a=track.findSegment(player.z);var r=utilPercentRemaining(player.z,Track.segmentLength);var i=utilInterpolate(a.p1.world.y,a.p3.world.y,r);var n=height;var s=0;var c=-(e.curve*t);context.fillStyle="#4576aa";cntxFillRect(0,0,width,height);renderBackground(backgroundLayer3,width,height,bgLayer3Offset,resolution*bgLayer3Speed*i);renderBackground(backgroundLayer2,width,height,bgLayer2Offset,resolution*bgLayer2Speed*i);renderBackground(backgroundLayer1,width,height,bgLayer1Offset,resolution*bgLayer1Speed*i);var o,l,d,h,u,f,x,v;for(o=0;o<camera.drawDistance;o++){d=track.getSegment((e.index+o)%track.getSegmentCount());d.looped=d.index<e.index;d.fog=renderExponentialFog(o/camera.drawDistance,camera.fogDensity);d.clip=n;camera.project(d.p1,-s,d.looped,width,height);camera.project(d.p2,-s,d.looped,width,height);camera.project(d.p3,-s-c,d.looped,width,height);camera.project(d.p4,-s-c,d.looped,width,height);s=s+c;c=c+d.curve;if(d.p1.camera.z<=camera.depth||d.p3.screen.y>=d.p1.screen.y||d.p3.screen.y>=n)continue;renderSegment(d);n=d.p1.screen.y}for(o=camera.drawDistance-1;o>0;o--){d=track.getSegment((e.index+o)%track.getSegmentCount());for(l=0;l<d.cars.length;l++){h=d.cars[l];if(h.index!==0){u=h.sprite;var p=utilInterpolate(d.p1.screen.scale,d.p3.screen.scale,h.percent);x=utilInterpolate((d.p1.screen.x+d.p2.screen.x)/2,(d.p3.screen.x+d.p4.screen.x)/2,h.percent)+p*h.x*width/2;v=utilInterpolate(d.p1.screen.y,d.p4.screen.y,h.percent);var u=SPRITES_CARSTRAIGHT;f=h.width*p/u.w;if(h.turnLeft){u=SPRITES_CARLEFT}else if(h.turnRight){u=SPRITES_CARRIGHT}renderSprite(u,f,x,v,d.clip,d.fog)}}for(l=0;l<d.sprites.length;l++){u=d.sprites[l];f=d.p1.screen.scale;x=d.p1.screen.x-d.p1.world.x*d.p1.screen.scale*width/2+f*u.x*width/2;v=d.p1.screen.y;f=u.s*f;renderSprite(u.source,f,x,v,d.clip,false);var g=u.source.w*f*width/2;var R=-0;var m=x+g*(R||0);f=d.p1.screen.scale;f=u.s*f;var T=u.source.cx*f*width/2;var S=u.source.cw*f*width/2;x=m+T}if(d==a){var y=utilInterpolate(a.p1.screen.y,a.p3.screen.y,r);y=height/2-camera.depth/camera.zOffset*utilInterpolate(a.p1.camera.y,a.p3.camera.y,r)*height/2;var C=y;if(cars[0].yOffset>0){y-=cars[0].yOffset*camera.depth/camera.zOffset*height/2}var E=width/2;var p=utilInterpolate(a.p1.screen.scale,a.p3.screen.scale,r);x=utilInterpolate((a.p1.screen.x+a.p2.screen.x)/2,(a.p3.screen.x+a.p4.screen.x)/2,r)+p*cars[0].x*width/2;var L={world:{x:player.x,y:player.y,z:player.z},camera:{},screen:{}};camera.project(L,0,a.index<e.index,width,height);E=L.screen.x;var w=0;if(player.speed>0){if(player.driftDirection!=0){w=player.driftDirection}else{w=player.turnLeft?-1:player.turnRight?1:0}}renderPlayer(camera.depth/camera.zOffset,E,y,w,a.p3.world.y-a.p1.world.y,C);if(race.state==STATE_RACING){context.drawImage(track.overheadMap,-40,200,400,400)}}}}var Car=function(){var e=this;e.sprite=0;e.index=0;e.width=500;e.height=0;e.x=0;e.y=0;e.lastY=false;e.yOffset=0;e.z=0;e.lap=0;e.lapStarted=false;e.position=0;e.centrifugal=.3;e.slipstreamLines=[];e.slipstreamLengths=false;e.slipstream=0;e.slipstreamTime=0;e.percent=0;e.speed=0;e.ySpeed=0;e.turboStartTime=0;e.accelerate=e.brake=e.turnLeft=e.turnRight=e.turbo=e.turboRequest=e.driftRequest=false;e.driftAmount=0;e.driftDirection=0;e.turboAmount=100;e.lapStarted=false;e.centrifugal=.3;e.maxSpeed=3e4;e.maxTurboSpeed=28e3;e.speedPercent=0;e.accel=6800;e.breaking=-16e3;e.decel=-8e3;e.currentLapTime=0;e.lastLapTime=null;e.position=0;e.turnSpeed=3e3;e.slowOnCorners=false;e.takeCornerOnInside=false;e.bounce=1.5;e.finishPosition=0};Car.prototype={doaccelerate:function(e,t,a){return e+t*a},initSlipstreamLines:function(){this.slipstreamLines=[];var e=400;var t=this.z+500;var a=e-40;var r=700;var i,n;var s=20;var c=0;if(this.slipstreamLengths===false){this.slipstreamLengths=[];for(i=0;i<s;i++){this.slipstreamLengths.push(mathRand())}}for(i=0;i<s;i++){this.slipstreamLengths[i]+=.03;if(this.slipstreamLengths[i]>=.8){this.slipstreamLengths[i]=0}var o=e+60;if(c>PI/6&&c<PI/2){o=e+60+(c-PI/6)*128}if(c>=PI/2&&c<5*PI/6){o=e+60+(5*PI/6-c)*128}var l=this.x+this.width/2+a*Math.cos(c-.05);var d=this.y+a*sin(c-.02);var h=this.x+this.width/2+a*Math.cos(c+.05);var u=this.y+a*sin(c+.02);var f=this.x+this.width/2+o*Math.cos(c-.05);var x=this.y+o*sin(c-.05);var v=this.x+this.width/2+o*Math.cos(c+.05);var p=this.y+o*sin(c+.05);var g=l+(f-l)*this.slipstreamLengths[i];var R=h+(v-h)*this.slipstreamLengths[i];var m=d+(x-d)*this.slipstreamLengths[i];var T=u+(p-u)*this.slipstreamLengths[i];var S=l+(f-l)*(this.slipstreamLengths[i]+.4);var y=h+(v-h)*(this.slipstreamLengths[i]+.4);var C=d+(x-d)*(this.slipstreamLengths[i]+.4);var E=u+(p-u)*(this.slipstreamLengths[i]+.4);var L=t-r*this.slipstreamLengths[i];var w=t-r*(this.slipstreamLengths[i]+.4);var I=[];I.push({world:{x:g,y:m,z:L},camera:{},screen:{}});I.push({world:{x:R,y:T,z:L},camera:{},screen:{}});I.push({world:{x:y,y:E,z:w},camera:{},screen:{}});I.push({world:{x:S,y:C,z:w},camera:{},screen:{}});this.slipstreamLines.push(I);c+=PI/s}for(i=0;i<this.slipstreamLines.length;i++){var A=this.slipstreamLines[i];for(n=0;n<A.length;n++){camera.project(A[n],0,0,width,height)}}},limit:function(e,t,a){return Math.max(t,Math.min(e,a))},overlap:function(e,t,a,r,i){var n=e-(i-1)*t/2;var s=e+t*i;var c=a-(i-1)*r/2;var o=a+r*i;return!(s<c||n>o)},setTurnLeft:function(e){this.turnLeft=e},setTurnRight:function(e){this.turnRight=e},setAccelerate:function(e){this.accelerate=e},setBrake:function(e){this.brake=e},setTurbo:function(e){this.turboRequest=e},setDrift:function(e){this.driftRequest=e},getCurrentLapTime:function(){return this.currentLapTime},getLap:function(){if(this.lap<1){return 1}return this.lap},getPosition:function(){var e=this.position,t=e%10,a=e%100;if(t==1&&a!=11){return e+"st"}if(t==2&&a!=12){return e+"nd"}if(t==3&&a!=13){return e+"rd"}return e+"th"},getSpeed:function(){return this.speed},update:function(e){var t=this.maxSpeed;this.speedPercent=this.speed/this.maxSpeed;var a=track.findSegment(this.z);var r=track.findSegment(cars[0].z);var i=this.speedPercent;this.percent=utilPercentRemaining(this.z,Track.segmentLength);var n=e*this.turnSpeed*i;var s=a.p1.world.x;var c=a.p2.world.x;var o=this.x;var l=this.x+this.width;var d=o-s;var h=c-l;var u=c-s;var f=1;if(a.curve<0&&d>0){if(this.index==0){f=1+(u-this.width-d)*-a.curve/(u*80)}}else if(a.curve>0&&h>0){if(this.index==0){f=1+(u-this.width-h)*a.curve/(u*80)}}if(f<1){f=1}var x=.8;var v=1;if(this.slipstreamTime>0){x+=.4}if(this.driftRequest){if(this.speed>8e3){if(!this.drift&&!this.accelerate){this.driftAmount=1.2;this.drift=true}}else{x-=.5;this.drift=false}}else{this.drift=false}if(this.driftAmount>0&&this.speed>8e3){this.driftAmount-=e;x-=.04;if(this.driftDirection==0){if(this.turnLeft){this.driftDirection=-1}if(this.turnRight){this.driftDirection=1}}}else{this.drift=false;this.driftAmount=0;this.driftDirection=0}var p=this.turbo;if(this.turboRequest){this.turbo=this.turboAmount>0&&this.speed>8e3&&this.accelerate}else{this.turbo=false}if(this.turbo){v=1.2;t=this.maxTurboSpeed}this.bounce=3.4;if(d<-this.width*.1||h<-this.width*.1){if(d+this.width*.1<-r.kerbWidth||h+this.width*.1<-r.kerbWidth){this.bounce=9.5;x-=.6;v-=.2}else{x-=.1;this.bounce=6}}this.bounce=this.bounce*mathRand()*i;if(this.index==0&&race.state!=STATE_RACEOVER){this.x=this.x-n*i*r.curve*this.centrifugal;if(this.driftDirection!=0){n=n*.5}if(this.turnLeft)this.x=this.x-n;else if(this.turnRight)this.x=this.x+n;var g=this.driftDirection*this.speed*55e-5;this.x+=g;this.z=utilIncrease(this.z,e*this.speed*f,track.getLength());this.y=utilInterpolate(a.p1.world.y,a.p3.world.y,this.percent);this.yOffset=0;if(this.accelerate){if(this.turbo){var R=getTimestamp();if(!p){this.turboStartTime=R}this.turboAmount-=e*2.45;raceAudioSetTurboTime(R-this.turboStartTime)}if(this.speed<t*x){this.speed=this.doaccelerate(this.speed,this.accel*v,e)}else{this.speed=this.doaccelerate(this.speed,this.decel,e);if(this.speed<t*x){this.speed=t*x}}}else if(this.brake){this.speed=this.doaccelerate(this.speed,this.breaking,e)}else{this.speed=this.doaccelerate(this.speed,this.decel,e)}for(var m=0;m<r.sprites.length;m++){var T=r.sprites[m];var S=T.s*T.source.cw;var y=T.x+T.source.cx*T.s;var C=this.x;if(this.overlap(C,this.width,y,S,1)){if(this.index==0){raceAudioCrash();this.slipstream=0;this.slipstreamTime=0}this.speed=t/5;this.z=utilIncrease(r.p1.world.z,0,track.getLength());break}}var E=false;for(var L=0;L<cars.length;L++){var w=cars[L].z-player.z;if(player.z>track.getLength()-1200){w-=track.getLength()}if(w>0&&w<1800){var I=(player.x-cars[L].x)/cars[L].width;if(I<0){I=-I}if(I<.4){E=true}}}if(E&&this.speed>8e3){this.slipstream+=e*1;if(this.slipstream>.14){this.slipstreamTime=2}}else{this.slipstream=0}if(this.slipstreamTime>0){this.slipstreamTime-=e}}else{if(this.speed<t){this.speed=this.doaccelerate(this.speed,this.accel,e)}var A=this.updateCarPosition(a,r,player.width);var b=this.x+A*n;if(a.curve==0){this.turnLeft=A==-1;this.turnRight=A==1}else{this.turnLeft=a.curve<-.5;this.turnRight=a.curve>.5}if(b+this.width<c*.6&&b>s*.8){this.x=b}this.z=utilIncrease(this.z,e*this.speed,track.getLength())}this.percent=utilPercentRemaining(this.z,Track.segmentLength);var k=track.findSegment(this.z);if(this.index===0){for(m=0;m<k.cars.length;m++){var O=k.cars[m];if(O.index!=this.index){if(this.speed>O.speed){if(this.overlap(this.x,this.width,O.x,O.width,1)){if(this.index!==0){this.speed=O.speed/2;if(O.index!==0){O.speed=O.speed*1.2}}else{if(this.index==0){raceAudioCrash();this.slipstream=0;this.slipstreamTime=0}this.speed=O.speed;this.z=O.z-100}break}}}}}if(this.x+this.width/2<s-1.2*this.width){this.x=s-1.2*this.width-this.width/2}if(this.x+this.width/2>c+1.2*this.width){this.x=c+1.2*this.width-this.width/2}this.speed=this.limit(this.speed,0,t);if(this.index==0){raceAudioEngineSpeed(this.speedPercent)}if(a!=k){var P=a.cars.indexOf(this);a.cars.splice(P,1);k.cars.push(this)}if(this.z<Track.segmentLength*1.2&&!this.lapStarted){this.lap++;this.lapStarted=true;this.lastLapTime=this.currentLapTime;if(this.lap==2&&this.index==0){speak("lap time "+this.getCurrentLapTime().toFixed(2))}this.currentLapTime=0}else{if(this.z>Track.segmentLength*1.2){this.lapStarted=false}this.currentLapTime+=e}var D=this.position;this.position=1;for(var L=0;L<cars.length;L++){if(L!=this.index){if(cars[L].lap>this.lap){this.position++}else if(cars[L].lap===this.lap){if(cars[L].z>this.z){this.position++}}}}if(this.index==0){if(this.newPositionTime>0){this.newPositionTime-=e}if(this.position!==D){this.newPosition=this.getPosition();this.newPositionTime=1}}if(this.index===0&&this.lap===3&&race.state!=STATE_RACEOVER){this.finishPosition=this.getPosition();speak("Race. Over.");speak(this.finishPosition+" Place");this.turbo=false;this.slipstream=0;this.slipstreamTime=0;race.raceOver()}},updateCarPosition:function(e,t,a){var r=60;var i=null;var s=track.getSegmentCount();for(var c=1;c<r;c++){i=track.getSegment((e.index+c)%s);var o=i.p1.world.x;var l=i.p2.world.x;var d=0;if(c<8){for(n=0;n<i.cars.length;n++){var h=i.cars[n];var u=h.x;var f=h.width;var x=h.x+h.width;if(l-x<this.width*1.4){d=-1}else if(u-o<this.width*1.4){d=1}else{if(u-o>l-x){d=-1}else{d=1}}return d*3/c}}}if(this.takeCornerOnInside){for(var c=1;c<r;c++){i=track.getSegment((e.index+c)%s);var o=i.p1.world.x;var l=i.p2.world.x;if(i.curve>0){if(c<5){return 1/5}return 2/c}if(i.curve<0){if(c<5){return-1/5}return 2/c}}}return 0}};var COLORS_KERBLIGHT="#a02222",COLORS_KERBDARK="#BBBBBB",COLORS_LANDLIGHT="#000000",COLORS_LANDDARK="#000000",COLORS_ROAD="#000000";var Track=function(){this.trackLength=0;this.currentAngle=0;this.segments=[];this.map=null};var laneWidth=1200;Track.segmentLength=300;var lanes=1;Track.prototype={buildTrack0:function(){COLORS_FOG=0;this.segments=[];this.addStraight(200);this.calculateLength()},createStreetLights:function(){var e=this.getSegmentCount();for(var t=0;t<e;t++){var a=this.segments[t];if(t%20==0){var r=a.p1.world.x;a.sprites.push({source:SPRITES_STREETLIGHTLEFT,s:12,x:r-12*SPRITES_STREETLIGHTLEFT.w+700});var r=a.p2.world.x;a.sprites.push({source:SPRITES_STREETLIGHTRIGHT,s:12,x:r-700})}}},createRoadsideObjects:function(e,t,a,r,i){var n=this.getSegmentCount();var s=0;for(var c=0;c<n;c++){var o=this.segments[c];var l=mathRand();if(o.curve!=0&&i){if(s%20==0){if(o.curve>0){var d=o.p1.world.x;o.sprites.push({source:SPRITES_TURNRIGHT,s:3,x:d-3*SPRITES_TURNRIGHT.w-400})}else{var d=o.p2.world.x;o.sprites.push({source:SPRITES_TURNLEFT,s:3,x:d+400})}}s++}else{s=0;var h=e[mathRandInt(e.length)];if(l>t){var d=o.p1.world.x;o.sprites.push({source:h,s:a,x:d-a*h.w/2-r});var d=o.p2.world.x;o.sprites.push({source:h,s:a,x:d-a*h.w/2+r})}}}},buildTrack1:function(){COLORS_ROAD="#3a3a3a";COLORS_LANDLIGHT="#047804",COLORS_LANDDARK="#006A00";COLORS_LANEMARKER=MEDIUMGREY;COLORS_FOG=0;resetGraphics();createTurnArrows();createTrees();createBackgroundTrees();createBackgroundMountains();createCars();var e=this;e.addStraight(50);e.addEasyCurve90(1,0);e.addRoad(50,50,39,0,40,0);e.addEasyCurve90(1,0);e.addStraight(25);e.addEasyCurve30(-1,0);e.addEasyCurve30(1,0);e.addHill(50,40);e.addEasyCurve90(1,0);e.addEasyCurve30(-1,0);e.addEasyCurve30(1,0);e.addEasyCurve90(1,-40);e.addStraight(50,-40);e.addStraight(55,0);e.calculateLength();e.drawMap();e.createRoadsideObjects(SPRITES_TREES,.9,10,900,true)},buildTrack2:function(){COLORS_ROAD="#3a3a3a";COLORS_LANDLIGHT="#047804";COLORS_LANDDARK="#006A00";COLORS_LANEMARKER=MEDIUMGREY;COLORS_FOG=0;resetGraphics();createCars();createTurnArrows();createTrees();createBackgroundTrees();createBackgroundMountains();createFlowers();var e=this;e.addStraight(20);e.addStraight(46,0);e.addEasyCurve90(1,30);e.addStraight(90,0);e.addMediumCurve90(1,0);e.addStraight(25,0);e.addMediumCurve90(1,50);e.addStraight(25,0);e.addMediumCurve90(-1,0);e.addStraight(68,-50);e.addMediumCurve90(-1,0);e.addMediumCurve90(1,0);e.addMediumCurve90(1,0);e.addStraight(48,0);e.addEasyCurve90(1,-30);e.addStraight(38,0);e.addEasyCurve30(-1,0);e.addEasyCurve30(1,0);e.calculateLength();e.drawMap();e.createRoadsideObjects([SPRITES_FLOWERS],.3,6,1300,true)},buildTrack3:function(){COLORS_ROAD="#3a3a3a";COLORS_LANDLIGHT="#5a5a5a";COLORS_LANDDARK="#626262";COLORS_LANEMARKER=MEDIUMGREY;COLORS_FOG=0;resetGraphics();createCars();createBuildings(false);createStreetlights(false);createBackgroundBuildings(false);createNightSky();var e=this;e.addStraight(100);e.addMediumCurve90(1,0);e.addStraight(151,0);e.addHardCurve90(1,0);e.addStraight(30,0);e.addHardCurve90(1,0);e.addStraight(80,0);e.addMediumCurve90(-1,0);e.addMediumCurve90(-1,0);e.addStraight(20,0);e.addMediumCurve90(1,0);e.addStraight(10,0);e.addHardCurve90(1,0);e.addStraight(50,0);e.addMediumCurve90(-1,0);e.addMediumCurve90(1,0);e.addMediumCurve90(1,0);e.addStraight(62,0);e.calculateLength();e.drawMap();e.createRoadsideObjects(SPRITES_BUILDINGS,.95,20,3300,false);e.createStreetLights()},buildTrack4:function(){COLORS_ROAD="#111111";COLORS_LANEMARKER="#555555";COLORS_FOG="#000000";COLORS_LANDLIGHT="#090909";COLORS_LANDDARK="#030303";resetGraphics();createCars();createBuildings(true);createStreetlights(true);createBackgroundBuildings(true);createBackgroundMountains();var e=this;e.addStraight(100);e.addHardCurve180(1,0);e.addHardCurve90(-1,0);e.addStraight(40,0);e.addHardCurve90(1,0);e.addHardCurve90(-1,0);e.addHardCurve90(1,0);e.addStraight(50,0);e.addMediumCurve90(-1,0);e.addStraight(20,0);e.addMediumCurve90(1,0);e.addHardCurve90(1,0);e.addStraight(60,0);e.addMediumCurve90(-1,0);e.addMediumCurve90(1,0);e.addStraight(51,0);e.addHardCurve90(1,0);e.addStraight(110,0);e.calculateLength();e.drawMap();e.createRoadsideObjects(SPRITES_BUILDINGS,.95,20,3300,false);e.createStreetLights()},lastY:function(){return this.segments.length==0?0:this.segments[this.segments.length-1].p3.world.y},getSegment:function(e){return this.segments[e]},getSegmentCount:function(){return this.segments.length},getLength:function(){return this.trackLength},calculateLength:function(){this.trackLength=track.segments.length*Track.segmentLength},addSegment:function(e,t){var a=this.segments.length;var r=this.lastY();var i=t;var n=a*Track.segmentLength;var s=(a+1)*Track.segmentLength;var c=-laneWidth;var o=laneWidth;var l=0;if(e!=0){l=e*40;if(l<0){l=-l}l+=60}this.segments.push({index:a,p1:{world:{x:c,y:r,z:n},camera:{},screen:{}},p2:{world:{x:o,y:r,z:n},camera:{},screen:{}},p3:{world:{x:o,y:i,z:s},camera:{},screen:{}},p4:{world:{x:c,y:i,z:s},camera:{},screen:{}},curve:e,kerbWidth:l,sprites:[],cars:[]})},easeIn:function(e,t,a){return e+(t-e)*Math.pow(a,2)},easeOut:function(e,t,a){return e+(t-e)*(1-Math.pow(1-a,2))},easeInOut:function(e,t,a){return e+(t-e)*(-Math.cos(a*Math.PI)/2+.5)},addRoad:function(e,t,a,r,i,n){var n=n||0;var s=this.currentAngle+n;var c=this.lastY();var o=c+Math.floor(i)*Track.segmentLength;var l,d=e+t+a;var h=0;var u=0;var f=this.segments.length;for(l=0;l<e;l++){h=this.easeIn(0,r,l/e);u+=h;this.addSegment(h,this.easeInOut(c,o,l/d))}for(l=0;l<t;l++){h=r;u+=h;this.addSegment(r,this.easeInOut(c,o,(e+l)/d))}for(l=0;l<a;l++){h=this.easeInOut(r,0,l/a);u+=h;this.addSegment(h,this.easeInOut(c,o,(e+t+l)/d))}var x=0;if(u!=0){x=(s-this.currentAngle)/u}for(var v=f;v<this.segments.length;v++){this.currentAngle+=this.segments[v].curve*x;this.segments[v].angle=this.currentAngle}this.currentAngle=s;this.segments[this.segments.length-1].angle=s},addStraight:function(e,t){t=t||0;this.addRoad(e,e,e,0,t,0)},addBumps:function(){this.addRoad(10,10,10,0,5);this.addRoad(10,10,10,0,-2);this.addRoad(10,10,10,0,-5);this.addRoad(10,10,10,0,8);this.addRoad(10,10,10,0,5);this.addRoad(10,10,10,0,-7);this.addRoad(10,10,10,0,5);this.addRoad(10,10,10,0,-2)},addEasyCurve90:function(e,t){this.addRoad(25,100*1.4,25,e*4.25,t,e*90)},addEasyCurve30:function(e,t){this.addRoad(25,50,25,e*4.25,t,e*30)},addMediumCurve90:function(e,t){this.addRoad(25,50*1.5,25,e*6*.96,t,e*90)},addHardCurve90:function(e){this.addRoad(18,50*.8,18,e*8,0,e*90)},addHardCurve180:function(){this.addRoad(50,50,50,7.5,0,180)},addHill:function(e,t){this.addRoad(e,e,e,0,t,0)},addRoadsideObject:function(e,t,a){var r=this.segments[e];var i=0;if(a<0){i=r.p1.world.x-600}else{i=r.p2.world.x+600}r.sprites.push({source:t,x:i})},findSegment:function(e){return this.segments[Math.floor(e/Track.segmentLength)%this.segments.length]},drawMap:function(){if(this.map==null){this.map=document.createElement("canvas")}this.map.width=600;this.map.height=600;cntx=this.map.getContext("2d");var e=canvas.width;var t=canvas.height;cntxClearRect(600,600);cntxStrokeStyle("#666666");cntx.lineWidth=5;var a=0;var r=300;var i=30;cntxBeginPath();var n=.5;cntxMoveTo(r,i);for(var s=0;s<this.segments.length;s++){a=this.segments[s].angle/180*PI;r+=n*cos(a);i+=n*sin(a);cntxLineTo(r,i);this.segments[s].x=r;this.segments[s].y=i}cntxStroke();cntxStrokeStyle(LIGHTGREY);cntx.lineWidth=4;cntxStroke();n=4;context.lineWidth=3;cntxStrokeStyle(LIGHTGREY);cntxBeginPath();a=(this.segments[0].angle+90)/180*PI;r-=n*cos(a);i-=n*sin(a);cntxMoveTo(r,i);r+=2*n*cos(a);i+=2*n*sin(a);cntxLineTo(r,i);cntxStroke()},drawOverheadTrack:function(){cntx=overheadTrack.x;this.overheadMap=overheadTrack.c;cntxClearRect(600,600);cntxDrawImage(this.map,0,0,600,600,0,0,600,600);for(var e=0;e<cars.length;e++){var t=cars[e].z;var a=track.findSegment(t);cntxBeginPath();cntxArc(a.x,a.y,5,0,2*PI,false);cntxFillStyle(DARKGREY);cntxFill();cntx.lineWidth=2;cntxStrokeStyle("#999999");cntxStroke()}var r=cars[0].z;var i=track.findSegment(r);cntxBeginPath();cntxArc(i.x,i.y,5,0,2*PI,false);cntxFillStyle("#ff0000");cntxFill();context.lineWidth=2;cntxStrokeStyle(MEDIUMGREY);cntxStroke()}};var track=null;var numbers=["ONE","TWO","THREE","FOUR","FIVE","SIX","SEVEN","EIGHT"];var Race=function(){this.track=null;this.state=0;this.countdownNumber=3;this.lastTime=0;this.carCount=15;this.trackNumber=0;this.zIsDown=false;this.xIsDown=false;this.raceNumber=3};var STATE_PRERACE=0;var STATE_COUNTDOWN=1;var STATE_RACING=4;var STATE_RACEOVER=5;Race.COUNTDOWN_INTERVAL=800;Race.prototype={init:function(){},start:function(e){raceAudioEngineSpeed(0);if(e>=4){e=0}e=3;this.raceNumber=e;track=new Track;switch(e){case 0:track.buildTrack1();break;case 1:track.buildTrack2();break;case 2:track.buildTrack3();break;case 3:track.buildTrack4();break}this.resetCars();player=cars[0];player.initSlipstreamLines();this.state=STATE_PRERACE;this.countdownNumber=4;this.lastTime=getTimestamp()},raceOver:function(){this.state=STATE_RACEOVER},keyDown:function(e){if(this.state!==STATE_RACEOVER){switch(e.keyCode){case 90:this.zIsDown=true;player.setDrift(true);break;case 88:this.xIsDown=true;player.setTurbo(true);break;case KEYUP:player.setAccelerate(true);break;case KEYDOWN:player.setBrake(true);break;case KEYLEFT:player.setTurnLeft(true);break;case KEYRIGHT:player.setTurnRight(true);break}}else{}},keyUp:function(e){if(this.state!=STATE_RACEOVER){switch(e.keyCode){case 90:this.zIsDown=false;player.setDrift(false);break;case 88:this.xIsDown=false;player.setTurbo(false);break;case KEYUP:player.setAccelerate(false);break;case KEYDOWN:player.setBrake(false);break;case KEYLEFT:player.setTurnLeft(false);break;case KEYRIGHT:player.setTurnRight(false);break}}else{if(e.keyCode==90){if(!this.zIsDown){this.start(this.raceNumber)}this.zIsDown=false}if(e.keyCode==88){if(!this.xIsDown){if(cars[0].finishPosition=="1st"){this.start(this.raceNumber+1)}}this.xIsDown=false}}},resetCars:function(){cars=[];var e,t,a,r,i,n,s;for(var e=0;e<this.carCount;e++){i=track.getLength()-(this.carCount-e)*Track.segmentLength*13;a=track.findSegment(i);var c=a.p1.world.x;var o=a.p2.world.x;t=new Car;var l=0;if(e%2){l=c/2}else{l=o/2-t.width}t.index=e;t.x=l;t.z=i;t.sprite=n;t.speed=0;t.percent=utilPercentRemaining(t.z,Track.segmentLength);if(t.index!==0){var d=23e3;if(t.index<8&&t.index>3){t.maxSpeed=d*.905-mathRand()*(this.carCount-e-1)*d/55}else if(t.index>12){t.maxSpeed=d*.905-(this.carCount-e-1)*d/65}else{t.maxSpeed=d*.905-(this.carCount-e-1)*d/45}t.accel=d/2;if(t.index<4){t.takeCornerOnInside=false}else if(t.index<8){t.takeCornerOnInside=mathRand()>.4;t.slowOnCorners=mathRand()>.6}}a.cars.push(t);cars.push(t)}},updatePrerace:function(e){var t=getTimestamp();if(t-this.lastTime>Race.COUNTDOWN_INTERVAL){this.lastTime=getTimestamp();this.countdownNumber--;if(this.countdownNumber==3){speak("RACE")}if(this.countdownNumber==2){speak(numbers[this.raceNumber])}if(this.countdownNumber<=0){this.state=STATE_COUNTDOWN;this.countdownNumber=3;raceAudioTone(220,1/4)}}camera.update(e)},updateCountdown:function(e){var t=getTimestamp();if(t-this.lastTime>Race.COUNTDOWN_INTERVAL){this.lastTime=getTimestamp();this.countdownNumber--;if(this.countdownNumber<=0){raceAudioTone(440,1/2);this.state=STATE_RACING}else{raceAudioTone(220,1/4)}}camera.update(e)},updateRace:function(e){var t=track.findSegment(player.z);var a=player.speedPercent;var r=e*2*a;var i=camera.z;for(var n=0;n<cars.length;n++){cars[n].update(e)}camera.update(e);bgLayer3Offset=utilIncrease(bgLayer3Offset,bgLayer3Speed*t.curve*(camera.z-i)/Track.segmentLength,1);bgLayer2Offset=utilIncrease(bgLayer2Offset,bgLayer2Speed*t.curve*(camera.z-i)/Track.segmentLength,1);bgLayer1Offset=utilIncrease(bgLayer1Offset,bgLayer1Speed*t.curve*(camera.z-i)/Track.segmentLength,1)},updateRaceOver:function(){},update:function(e){switch(this.state){case STATE_PRERACE:this.updatePrerace(e);break;case STATE_COUNTDOWN:this.updateCountdown(e);break;case STATE_RACEOVER:case STATE_RACING:this.updateRace(e);break}},render:function(){renderRender();if(this.state==STATE_PRERACE){context.font="italic bold 350px "+helvetica;if(this.countdownNumber<4){cntxFillStyle(DARKGREY);cntxFillText("RACE",14,304);cntxFillStyle(LIGHTGREY);cntxFillText("RACE",10,300)}if(this.countdownNumber<3){if(this.raceNumber==0){context.font="italic bold 440px "+helvetica}else if(this.raceNumber==1){context.font="italic bold 430px "+helvetica}else if(this.raceNumber==2){context.font="italic bold 290px "+helvetica}else if(this.raceNumber==3){context.font="italic bold 358px "+helvetica}cntxFillStyle(DARKGREY);cntxFillText(numbers[this.raceNumber],14,674);cntxFillStyle(LIGHTGREY);cntxFillText(numbers[this.raceNumber],10,670)}}if(this.state==STATE_COUNTDOWN){context.font=" 300px "+helvetica;context.fillStyle="#111111";context.fillText(this.countdownNumber,449,254);context.fillStyle=LIGHTGREY;context.fillText(this.countdownNumber,445,250)}if(this.state==STATE_RACING){cntxFillStyle(LIGHTGREY);cntxStrokeStyle(LIGHTGREY);context.font=" 80px "+helvetica;context.fillText(player.getPosition(),10,80);context.font=" 40px "+helvetica;context.fillText("Lap "+player.getLap()+" of 2",10,130);context.fillText("Lap Time: "+player.getCurrentLapTime().toFixed(2),10,180);context.font=" 80px "+helvetica;var e=("000"+Math.round(player.getSpeed()/100).toString(10)).substr(-3);context.fillText(e+"km/h",695,80);context.font=" 40px "+helvetica;context.fillText("Turbo ",670,136);cntxBeginPath();context.rect(796,110,208,28);cntxStroke();cntxFillRect(800,114,player.turboAmount*2,20);if(cars[0].newPositionTime>0){context.font=" 160px "+helvetica;cntxFillStyle(LIGHTGREY);context.fillText(cars[0].getPosition(),334,184)}}if(this.state==STATE_RACEOVER){context.font=" 300px "+helvetica;cntxFillStyle(LIGHTGREY);context.fillText(cars[0].finishPosition,300,290);context.font=" 40px "+helvetica;var t=380;if(cars[0].finishPosition=="1st"){context.fillText("x: Next Race",397,t);t+=80}context.fillText("z: Retry",445,t)}}};var canvas=document.getElementById("gameCanvas");var context=canvas.getContext("2d");var racing=false;var getTimestamp=function(){return performance.now()};document.addEventListener("keydown",function(e){if(racing){race.keyDown(e)}else{titleScreen.keyDown(e)}});document.addEventListener("keyup",function(e){if(racing){race.keyUp(e)}else{titleScreen.keyUp(e)}});var now=getTimestamp();var last=getTimestamp();var dt=0;var gdt=0;var cars=[];var player=null;var camera=new Camera;var race=new Race;track=new Track;var titleScreen=new TitleScreen(canvas,context);function startGame(e){raceAudioInit();speak("Start");racing=true;camera.reset();race.start(0)}titleScreen.init();function frame(){now=getTimestamp();dt=Math.min(1,(now-last)/1e3);gdt=gdt+dt;if(!racing){titleScreen.render(dt);gdt=0}else{outlineOnly=false;var e=1/180;while(gdt>e){gdt=gdt-e;race.update(e)}track.drawOverheadTrack();race.render();last=now}requestAnimationFrame(frame)}frame();var audioCtx=null;var noiseBuffer=null;var audioScriptNode=null;var audioScriptGain=null;var audioEngineFrame=0;var audioTurboFrame=0;var audioScriptSpeed=1;var audioTurboSpeed=1;var audioEngineData=[];var audioTurboData=[];function raceAudioSetTurboTime(e){audioTurboSpeed=1+e/1e4}function raceAudioInit(){if(audioCtx==null){audioCtx=new(window.AudioContext||window.webkitAudioContext);raceAudioCreateEngineBuffer();raceAudioCreateTurboBuffer();raceAudioCreateNoiseBuffer();audioScriptNode=audioCtx.createScriptProcessor(1024,1,1);audioScriptNode.onaudioprocess=function(e){var t=e.outputBuffer.getChannelData(0);var a;for(var r=0;r<t.length;++r){if(player.turbo){audioEngineFrame+=audioScriptSpeed+Math.random();audioTurboFrame+=audioTurboSpeed;a=Math.floor(audioTurboFrame)%audioTurboData.length;t[r]=audioTurboData[a];a=Math.floor(audioEngineFrame)%audioEngineData.length;t[r]+=audioEngineData[a]+Math.random()*.01}else{audioEngineFrame+=audioScriptSpeed+Math.random()*1;a=Math.floor(audioEngineFrame)%audioEngineData.length;t[r]=audioEngineData[a]+Math.random()*.01}if(player.slipstreamTime>0){t[r]+=Math.random()*.4}}audioEngineFrame%=audioEngineData.length;audioTurboFrame%=audioTurboData.length};audioScriptGain=audioCtx.createGain();audioScriptGain.gain.value=.14;audioScriptNode.connect(audioScriptGain);audioScriptGain.connect(audioCtx.destination)}}function raceAudioCreateTurboBuffer(){var e=1024;audioTurboData=[];var t=0;for(var a=0;a<e;a++){for(var r=0;r<12;r++){audioTurboData[t++]=Math.random()*.01;if(t>=e){break}}var i=.2;if(t<e){for(var n=0;n<2;n++){audioTurboData[t++]=i;if(t>=e){break}}}}for(var a=0;a<e;a++){audioTurboData[a]+=Math.random()*.5-.05}}function raceAudioCreateEngineBuffer(){var e=1024;audioEngineData=[];var t=1;var a,r;var i=0;audioEngineData[i++]=1;for(var n=.05;n<1;n+=Math.random()/8+.01){r=Math.floor(n*e);a=Math.random()*2-1;var s=r-(i-1);var c=(a-t)/s;for(var o=0;o<s;o++){audioEngineData[i++]=t+c*o}t=a}s=e-(i-1);var c=(1-t)/s;for(var o=0;o<s;o++){audioEngineData[i++]=t+c*o}}function raceAudioCreateNoiseBuffer(){var e=2*audioCtx.sampleRate;noiseBuffer=audioCtx.createBuffer(1,e,audioCtx.sampleRate);var t=noiseBuffer.getChannelData(0);for(var a=0;a<e;a++){t[a]=Math.random()*2-1}}function raceAudioTone(e,t){var a=audioCtx.createGain();var r=audioCtx.createOscillator();r.connect(a);a.connect(audioCtx.destination);r.type="triangle";r.frequency.value=e;a.gain.value=.1;r.start(audioCtx.currentTime);r.stop(audioCtx.currentTime+t)}function raceAudioEngineSpeed(e){audioScriptSpeed=.2+e*2}function raceAudioEngineStop(){}var lastCrashTime=0;function raceAudioCrash(){var e=getTimestamp();if(e-lastCrashTime<1e3){return}lastCrashTime=e;var t=1/2;var a=audioCtx.createGain();var r=null;r=audioCtx.createBufferSource();r.connect(a);a.connect(audioCtx.destination);r.buffer=noiseBuffer;a.gain.linearRampToValueAtTime(.5,audioCtx.currentTime);a.gain.linearRampToValueAtTime(0,audioCtx.currentTime+t*.7);r.playbackRate.setValueAtTime(.035,audioCtx.currentTime);r.playbackRate.setValueAtTime(.002,audioCtx.currentTime+t);r.start(audioCtx.currentTime);r.stop(audioCtx.currentTime+t)}function drawBuffer(e){var t=document.getElementById("debugCanvas");var a=t.getContext("2d");var r=200;a.strokeStyle="#dddddd";a.beginPath();a.moveTo(0,300+e[0]*r);for(var i=1;i<e.length;i+=2){a.lineTo(i,300+e[i]*r)}a.stroke()}var english_voice="";function speak(e){var t=window.speechSynthesis.getVoices();if(english_voice==""){for(var a=0;a<t.length;a++){if(t[a].lang==="en-GB"){english_voice=t[a];break}}if(english_voice===""&&t.length>0){english_voice=t[0]}}var r=new SpeechSynthesisUtterance;r.text=e;if(english_voice!=""){r.voice=english_voice}window.speechSynthesis.speak(r)}